---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: readsb-protobuf
  namespace: home-automation
spec:
  interval: 5m
  chart:
    spec:
      chart: readsb-protobuf
      version: 8.3.2
      sourceRef:
        kind: HelmRepository
        name: k8s-at-home-charts
        namespace: flux-system
      interval: 5m

  values:
    image:
      # -- image repository
      repository: mikenye/readsb-protobuf
      # -- image tag
      tag: "v4.0.3"
      # -- image pull policy
      pullPolicy: IfNotPresent

    # -- environment variables. See [application docs](https://flightaware.com/adsb/piaware/advanced_configuration) for more details.
    # @default -- See below
    env:
      # -- Set the container timezone
      TZ: "${TIMEZONE}"
      READSB_DCFILTER: true
      READSB_DEVICE_TYPE: rtlsdr
      READSB_FIX: true
      READSB_GAIN: autogain
      READSB_LAT: "${LATITUDE}"
      READSB_LON: "${LONGITUDE}"
      READSB_MODEAC: true
      READSB_RX_LOCATION_ACCURACY: 2
      READSB_STATS_RANGE: true
      READSB_NET_ENABLE: true

    # -- Configures service settings for the chart.
    # @default -- See values.yaml
    service:
      main:
        ports:
          http:
            enabled: true
            port: 8080
          beastoutput:
            enabled: true
            port: 30005
            protocol: tcp

    ingress:
      # -- Enable and configure ingress settings for the chart under this key.
      # @default -- See values.yaml
      main:
        enabled: true
        #       ingressClassName: "traefik"
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt
          kubernetes.io/ingress.class: "traefik"
        hosts:
          - host: &host "readsb.peterduckett.me"
            paths:
              - path: /
        tls:
          - secretName: tls.readsb
            hosts:
              - *host

    securityContext:
      # -- (bool) Privileged securityContext may be required if USB device is accessed directly through the host machine
      privileged: true

    # -- Configure persistence settings for the chart under this key.
    # @default -- See values.yaml
    persistence:
      # -- Configure a hostPathMount to mount a USB device in the container.
      # @default -- See values.yaml
      usb:
        enabled: true
        type: hostPath
        hostPath: /dev/bus/usb/001/004
      
      autogain:
        enabled: true
        mountPath: /run/autogain
        existingClaim:

      collectd:
        enabled: true
        mountPath: /run/collectd
        existingClaim:


    # -- Affinity constraint rules to place the Pod on a specific node.
    # [[ref]](https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#affinity-and-anti-affinity)
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: feature.node.kubernetes.io/custom-flightaware
                  operator: In
                  values:
                    - "true"
